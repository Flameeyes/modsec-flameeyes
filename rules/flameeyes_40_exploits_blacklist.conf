# -*- apache -*-
# Copyright © 2010-2013 Diego Elio Pettenò <flameeyes@flameeyes.eu>
#

# If noticing access to known vulnerabilities, not only reject the
# request, but also put the IP address in a blacklist for a while.

SecRule REQUEST_URI "@beginsWith /w00tw00t" \
	"id:434000,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule REQUEST_URI "@contains plm=0" \
	"id:434010,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule REQUEST_URI "@contains /Y-ivrrecording.php" \
	"id:434020,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule REQUEST_URI "/timthumb\.php?src=.*(?:picasa|blogger|flickr)\.com\..*" \
        "id:434030,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule REQUEST_URI "@beginsWith /vtigercrm" \
	"id:434040,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

# The next two might cause people actually using jDownload to have
# failures, if that's the case please disable the rules by ID.
SecRule REQUEST_URI "@beginsWith /images/jdownloads/screenshots" \
	"id:434050,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule REQUEST_URI "@streq /components/com_jdownloads/jdownloads.js"
	"id:434060,phase:1,msg:'Known vulnerability requested, %{REMOTE_ADDR} blacklisted.',setvar:ip.blacklisted=1,expirevar:ip.blacklisted=%{TX.IP_EXPIRATION}"

SecRule IP:BLACKLISTED "@eq 1" "id:434090,phase:1,deny,status:403,nolog"
